> [9. Metodolog√≠a de Dise√±o de Arquitectura - Aplicaci√≥n de ADD](../../9.md) ‚Ä∫ [9.3. Iteraci√≥n 2: Identificar estructuras para soportar la funcionalidad primaria](../9.3.md) ‚Ä∫ [9.3.5. Vistas y Decisiones](9.3.5.md)

# 9.3.5. Vistas y Decisiones

## Vistas y Decisiones

Esta secci√≥n presenta las vistas de componentes y diagramas de secuencia para los casos de uso principales.

---

### Vista 1: Diagrama de Secuencia - CU06: Enviar Mensaje en Sala

![Diagrama de Secuencia - CU06: Enviar Mensaje en Sala](./diagrama/SECUENCIA.png)

---

### Vista 2: Diagrama de Secuencia - CU04: Registrar Idea

![Diagrama de Secuencia - CU04: Registrar Idea](./diagrama/SECUENCIA2.png)

---

### Vista 3: Diagrama de Componentes - MS Colaboraci√≥n (C4 Level 3)

Para ver el diagrama completo de componentes del MS Colaboraci√≥n, consultar [Secci√≥n 6.3](../../../6/6.3/6.3.md).

---

### Decisiones de Dise√±o

#### Decisi√≥n 1: Layered Architecture para Todos los Microservicios

| Aspecto | Detalle |
|---|---|
| **Contexto** | Necesidad de estructura interna consistente y mantenible |
| **Decisi√≥n** | Aplicar Layered Architecture (Presentaci√≥n ‚Üí Aplicaci√≥n ‚Üí Dominio ‚Üí Infraestructura) |
| **Alternativas** | Hexagonal Architecture pura, Clean Architecture |
| **Justificaci√≥n** | - NestJS facilita implementaci√≥n de capas<br/>- Equipo familiarizado con el patr√≥n<br/>- Cumple ESC-06 (mantenibilidad) |
| **Consecuencias** | ‚úÖ C√≥digo organizado y testeable<br/>‚úÖ F√°cil onboarding<br/>‚ö†Ô∏è Posible sobre-ingenier√≠a en servicios simples |

#### Decisi√≥n 2: Repository Pattern para Persistencia

| Aspecto | Detalle |
|---|---|
| **Contexto** | M√∫ltiples tecnolog√≠as de BD (PostgreSQL, MongoDB, Elasticsearch) |
| **Decisi√≥n** | Abstraer acceso a datos mediante Repository Pattern |
| **Alternativas** | ORMs directos en Services, Data Mappers |
| **Justificaci√≥n** | - Desacopla l√≥gica de negocio de tecnolog√≠a de BD<br/>- Facilita testing con mocks<br/>- Permite cambiar implementaci√≥n sin afectar Services |
| **Consecuencias** | ‚úÖ Testabilidad mejorada<br/>‚úÖ Flexibilidad de BD<br/>‚ö†Ô∏è Capa adicional de abstracci√≥n |

#### Decisi√≥n 3: Adapter Pattern para Servicios Externos

| Aspecto | Detalle |
|---|---|
| **Contexto** | Integraci√≥n con Stripe, SendGrid, S3, Expo Push, Elasticsearch |
| **Decisi√≥n** | Encapsular integraciones en Adapters con interfaces |
| **Alternativas** | Llamadas directas desde Services, librer√≠as sin abstracci√≥n |
| **Justificaci√≥n** | - Permite cambiar proveedores (ej: SendGrid ‚Üí Mailgun)<br/>- Facilita testing con mocks<br/>- Centraliza configuraci√≥n de APIs externas |
| **Consecuencias** | ‚úÖ Flexibilidad de proveedores<br/>‚úÖ Testabilidad<br/>‚ö†Ô∏è C√≥digo adicional de abstracci√≥n |

#### Decisi√≥n 4: WebSocket Gateway con Socket.IO

| Aspecto | Detalle |
|---|---|
| **Contexto** | Necesidad de comunicaci√≥n en tiempo real para chat (CU06, CU07) |
| **Decisi√≥n** | Usar `@WebSocketGateway()` de NestJS con Socket.IO |
| **Alternativas** | WebSockets nativos, Server-Sent Events, Polling |
| **Justificaci√≥n** | - Socket.IO maneja reconexiones autom√°ticas<br/>- Soporte de rooms para salas de chat<br/>- Integraci√≥n nativa con NestJS<br/>- Fallback a polling si WebSocket no disponible |
| **Consecuencias** | ‚úÖ Comunicaci√≥n bidireccional eficiente<br/>‚úÖ Manejo de reconexiones<br/>‚ö†Ô∏è Requiere Redis para escalado horizontal (Iteraci√≥n 3) |

#### Decisi√≥n 5: DTOs con Validaci√≥n Autom√°tica

| Aspecto | Detalle |
|---|---|
| **Contexto** | Necesidad de validar entrada de usuarios |
| **Decisi√≥n** | Usar DTOs con decoradores de `class-validator` y `ValidationPipe` global |
| **Alternativas** | Validaci√≥n manual en Services, Joi schemas |
| **Justificaci√≥n** | - Validaci√≥n declarativa y legible<br/>- Integraci√≥n nativa con NestJS<br/>- Type-safe con TypeScript<br/>- Mensajes de error autom√°ticos |
| **Consecuencias** | ‚úÖ C√≥digo limpio y declarativo<br/>‚úÖ Validaci√≥n consistente<br/>‚ö†Ô∏è Dependencia de decoradores |

---

### Mapeo de Escenarios a Componentes

| Escenario | Componentes Involucrados | C√≥mo se Aborda |
|---|---|---|
| **ESC-06**: Cambio en l√≥gica de salas <4h | `ChatService`, `RoomRepository` | Cambios aislados en Service, sin afectar Controller ni Gateway |
| **ESC-07**: Crear sala al crear idea | `EventConsumer`, `ChatService` | Consumidor escucha `IdeaCreated` y llama `ChatService.createRoom()` |

---

### Cobertura de Casos de Uso

| Caso de Uso | Componentes Principales | Estado |
|---|---|---|
| CU01: Registro | `AuthController`, `AuthService`, `UserRepository` | ‚úÖ Mapeado |
| CU02: Login | `AuthController`, `AuthService`, `JwtAdapter` | ‚úÖ Mapeado |
| CU04: Registrar idea | `IdeaController`, `IdeaService`, `IdeaRepository`, `S3Adapter` | ‚úÖ Mapeado |
| CU05: Explorar ideas | `SearchController`, `SearchService`, `ElasticsearchAdapter` | ‚úÖ Mapeado |
| CU06: Enviar mensaje | `ChatGateway`, `ChatService`, `MessageRepository`, `RedisAdapter` | ‚úÖ Mapeado |
| CU07: Recibir mensajes | `ChatGateway`, `PresenceService`, `RedisAdapter` | ‚úÖ Mapeado |
| CU08: Crear sala | `ChatController`, `ChatService`, `RoomRepository` | ‚úÖ Mapeado |
| CU09: Ver participantes | `ChatController`, `ChatService`, `PresenceService` | ‚úÖ Mapeado |

**Cobertura**: 8/13 casos de uso principales mapeados (62%)

---

### Pr√≥ximos Pasos

En la **Iteraci√≥n 3**, se refinar√° el Microservicio de Colaboraci√≥n para abordar el atributo de calidad m√°s importante: **Rendimiento en Tiempo Real** (ESC-01, ESC-08).

---

[‚¨ÖÔ∏è Anterior](../9.3.4/9.3.4.md) | [üè† Home](../../../README.md) | [Siguiente ‚û°Ô∏è](../9.3.6/9.3.6.md)