> [9. Metodolog√≠a de Dise√±o de Arquitectura - Aplicaci√≥n de ADD](../../9.md) ‚Ä∫ [9.3. Iteraci√≥n 2: Identificar estructuras para soportar la funcionalidad primaria](../9.3.md) ‚Ä∫ [9.3.4. Elementos instanciados](9.3.4.md)

# 9.3.4. Elementos instanciados

## Elementos Instanciados

Esta secci√≥n presenta los componentes concretos instanciados en cada microservicio. Para detalles completos, consultar la [Secci√≥n 6.3 - Diagrama de Componentes](../../../6/6.3/6.3.md).

---

### Resumen de Componentes por Microservicio

| Microservicio | Controllers | Services | Repositories | Adapters | Otros |
|---|---|---|---|---|---|
| **Perfil** | 3 | 3 | 1 | 3 | 1 EventPublisher |
| **Ideas** | 3 | 3 | 2 | 2 | 1 EventPublisher |
| **B√∫squeda** | 1 | 3 | 0 | 1 | 2 (QueryBuilder, EventConsumer) |
| **Colaboraci√≥n** | 2 | 3 | 3 | 3 | 3 (Gateway, EventPublisher, EventConsumer) |
| **Pagos** | 3 | 3 | 2 | 1 | 1 EventPublisher |

**Total de componentes instanciados**: **52 componentes**

---

### Microservicio de Colaboraci√≥n (Detalle Completo)

Por su relevancia en los atributos de calidad, se detalla completamente el MS Colaboraci√≥n:

```mermaid
graph TB
    subgraph "Capa de Presentaci√≥n"
        CC[ChatController<br/>REST API]
        AC[ApplicationController<br/>REST API]
        CG[ChatGateway<br/>WebSocket]
    end
    
    subgraph "Capa de Aplicaci√≥n"
        CS[ChatService]
        AS[ApplicationService]
        PS[PresenceService]
    end
    
    subgraph "Capa de Infraestructura"
        MR[MessageRepository]
        RR[RoomRepository]
        AR[ApplicationRepository]
        RA[RedisAdapter]
        S3[S3Adapter]
        EP[ExpoPushAdapter]
        EVP[EventPublisher]
        EVC[EventConsumer]
    end
    
    CC --> CS
    AC --> AS
    CG --> CS
    CG --> PS
    
    CS --> MR
    CS --> RR
    CS --> RA
    CS --> EVP
    CS --> S3
    
    AS --> AR
    AS --> EVP
    AS --> EP
    
    PS --> RA
    
    EVC --> CS
```

#### Componentes del MS Colaboraci√≥n

**Controllers**:
- `ChatController`: Endpoints REST para salas y mensajes (`GET /chat/rooms`, `POST /chat/rooms`, `GET /chat/rooms/:id/messages`)
- `ApplicationController`: Endpoints de postulaciones (`POST /applications`, `PUT /applications/:id/accept`)

**Gateway**:
- `ChatGateway`: Maneja conexiones WebSocket, eventos `message:send`, `message:receive`, `user:typing`, `user:online`

**Services**:
- `ChatService`: L√≥gica de salas y mensajes, orquesta repositorios y adaptadores
- `ApplicationService`: L√≥gica de postulaciones a proyectos
- `PresenceService`: Gesti√≥n de usuarios conectados/desconectados

**Repositories**:
- `MessageRepository`: CRUD de mensajes en PostgreSQL
- `RoomRepository`: CRUD de salas en PostgreSQL
- `ApplicationRepository`: CRUD de postulaciones en PostgreSQL

**Adapters**:
- `RedisAdapter`: Pub/Sub para sincronizaci√≥n entre instancias de Socket.IO
- `S3Adapter`: Subida de archivos adjuntos en mensajes
- `ExpoPushAdapter`: Env√≠o de notificaciones push cuando usuario offline

**Event Handlers**:
- `EventPublisher`: Publica `MessageSent`, `ApplicationSubmitted` a RabbitMQ
- `EventConsumer`: Consume `IdeaCreated` para crear sala autom√°ticamente

---

### Mapeo de Casos de Uso a Componentes

#### CU06: Enviar mensaje en una sala

| Paso | Componente | Acci√≥n |
|---|---|---|
| 1 | `ChatGateway` | Recibe evento `message:send` via WebSocket |
| 2 | `ChatService` | Valida permisos, crea mensaje |
| 3 | `MessageRepository` | Persiste mensaje en PostgreSQL |
| 4 | `RedisAdapter` | Publica mensaje a otras instancias |
| 5 | `EventPublisher` | Publica evento `MessageSent` a RabbitMQ |
| 6 | `ChatGateway` | Emite `message:receive` a todos los clientes de la sala |

#### CU07: Recibir mensajes en tiempo real

| Paso | Componente | Acci√≥n |
|---|---|---|
| 1 | Cliente | Conecta WebSocket y se une a sala |
| 2 | `ChatGateway` | Registra cliente en sala de Socket.IO |
| 3 | `PresenceService` | Marca usuario como online en Redis |
| 4 | `ChatGateway` | Escucha eventos de `RedisAdapter` |
| 5 | `ChatGateway` | Emite mensajes recibidos a cliente |

#### CU08: Crear/unirse a sala de colaboraci√≥n

| Paso | Componente | Acci√≥n |
|---|---|---|
| 1 | `ChatController` | Recibe `POST /chat/rooms` |
| 2 | `ChatService` | Valida datos, crea sala |
| 3 | `RoomRepository` | Persiste sala en PostgreSQL |
| 4 | `ChatService` | Retorna ID de sala creada |

#### CU09: Ver participantes y estados

| Paso | Componente | Acci√≥n |
|---|---|---|
| 1 | `ChatController` | Recibe `GET /chat/rooms/:id/participants` |
| 2 | `ChatService` | Consulta participantes de sala |
| 3 | `PresenceService` | Consulta estados de conexi√≥n en Redis |
| 4 | `ChatService` | Combina datos y retorna lista |

---

### Interfaces Clave

#### Interface: IMessageRepository

```typescript
interface IMessageRepository {
  create(data: CreateMessageDto): Promise<Message>;
  findByRoom(roomId: string, limit: number, offset: number): Promise<Message[]>;
  markAsRead(messageId: string, userId: string): Promise<void>;
}
```

#### Interface: IRedisAdapter

```typescript
interface IRedisAdapter {
  publish(channel: string, message: any): Promise<void>;
  subscribe(channel: string, handler: (message: any) => void): void;
  setPresence(userId: string, status: 'online' | 'offline'): Promise<void>;
  getPresence(userId: string): Promise<'online' | 'offline'>;
}
```

#### Interface: IEventPublisher

```typescript
interface IEventPublisher {
  publish(eventName: string, payload: any): Promise<void>;
}
```

---

### Modelo de Datos - MS Colaboraci√≥n

#### Tabla: Messages

| Campo | Tipo | Descripci√≥n |
|---|---|---|
| id | UUID | Primary Key |
| roomId | UUID | Foreign Key ‚Üí Rooms |
| userId | UUID | ID del autor |
| content | TEXT | Contenido del mensaje |
| attachmentUrl | VARCHAR | URL de archivo adjunto (S3) |
| createdAt | TIMESTAMP | Fecha de creaci√≥n |
| readBy | JSON | Array de userIds que leyeron |

#### Tabla: Rooms

| Campo | Tipo | Descripci√≥n |
|---|---|---|
| id | UUID | Primary Key |
| ideaId | UUID | ID de la idea asociada |
| name | VARCHAR | Nombre de la sala |
| type | ENUM | 'public', 'private' |
| createdBy | UUID | ID del creador |
| createdAt | TIMESTAMP | Fecha de creaci√≥n |

#### Tabla: Applications

| Campo | Tipo | Descripci√≥n |
|---|---|---|
| id | UUID | Primary Key |
| projectId | UUID | ID del proyecto |
| userId | UUID | ID del postulante |
| message | TEXT | Mensaje de postulaci√≥n |
| portfolioUrl | VARCHAR | URL de portafolio |
| status | ENUM | 'pending', 'accepted', 'rejected' |
| createdAt | TIMESTAMP | Fecha de postulaci√≥n |

---

### Conclusi√≥n

Se han instanciado **52 componentes** distribuidos en los 5 microservicios, siguiendo patrones de dise√±o establecidos (Layered Architecture, Repository, Adapter, DI). Cada componente tiene una responsabilidad clara y est√° mapeado a casos de uso espec√≠ficos.

---

[‚¨ÖÔ∏è Anterior](../9.3.3/9.3.3.md) | [üè† Home](../../../README.md) | [Siguiente ‚û°Ô∏è](../9.3.5/9.3.5.md)