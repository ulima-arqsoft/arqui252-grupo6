> [9. Metodolog√≠a de Dise√±o de Arquitectura - Aplicaci√≥n de ADD](../../9.md) ‚Ä∫ [9.4. Iteraci√≥n 3: Refinar estructuras para abordar el atributo de calidad m√°s importante](../9.4.md) ‚Ä∫ [9.4.4. Elementos instanciados](9.4.4.md)

## 9.4.4. Elementos instanciados

## Elementos Instanciados

Esta secci√≥n presenta los elementos de infraestructura y configuraci√≥n a√±adidos para optimizar el rendimiento.

---

### Arquitectura Refinada del MS Colaboraci√≥n

![Diagrama de Secuencia - CU04: Registrar Idea](./diagrama/colaboracion.png)

---

### Elementos de Infraestructura Instanciados

#### 1. Redis Pub/Sub Adapter

| Atributo | Valor |
|---|---|
| **Prop√≥sito** | Sincronizaci√≥n de eventos WebSocket entre instancias |
| **Tecnolog√≠a** | Redis 7.0 + Socket.IO Redis Adapter |
| **Configuraci√≥n** | 2 clientes Redis (pub + sub) |
| **Canales** | `socket.io#/#` (autom√°tico por Socket.IO) |

#### 2. Redis Cache

| Atributo | Valor |
|---|---|
| **Prop√≥sito** | Cach√© de mensajes recientes por sala |
| **Estrategia** | Cache-Aside |
| **TTL** | 5 minutos |
| **Estructura de Keys** | `room:{roomId}:messages:recent` |
| **Tama√±o Estimado** | ~50 mensajes √ó 50 salas √ó 1KB = ~2.5MB |

#### 3. Load Balancer NGINX

| Atributo | Valor |
|---|---|
| **Algoritmo** | Round-robin (sin sticky sessions) |
| **Health Check** | `GET /health` cada 10s |
| **Timeout** | 60s para WebSocket |
| **Configuraci√≥n** | Proxy pass a pods Kubernetes |

**Configuraci√≥n NGINX**:

```nginx
upstream collaboration_backend {
    server collaboration-service-1:3004;
    server collaboration-service-2:3004;
    server collaboration-service-3:3004;
}

server {
    listen 80;
    
    location /ws/chat {
        proxy_pass http://collaboration_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 60s;
    }
}
```

#### 4. M√∫ltiples Instancias del MS Colaboraci√≥n

| Atributo | Valor |
|---|---|
| **M√≠nimo de R√©plicas** | 2 |
| **M√°ximo de R√©plicas** | 10 |
| **Escalado Autom√°tico** | HPA basado en CPU (70%) y Memoria (80%) |
| **Recursos por Pod** | CPU: 500m-1000m, Memory: 512Mi-1Gi |

**Deployment Kubernetes**:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: collaboration-service
spec:
  replicas: 2
  selector:
    matchLabels:
      app: collaboration-service
  template:
    metadata:
      labels:
        app: collaboration-service
    spec:
      containers:
      - name: collaboration
        image: nexus/collaboration-service:latest
        ports:
        - containerPort: 3004
        env:
        - name: REDIS_URL
          value: "redis://redis-cluster:6379"
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: connection-string
        resources:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 1Gi
        livenessProbe:
          httpGet:
            path: /health
            port: 3004
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 3004
          initialDelaySeconds: 5
          periodSeconds: 5
```

#### 5. RabbitMQ Queue para Persistencia As√≠ncrona

| Atributo | Valor |
|---|---|
| **Queue Name** | `message.persist` |
| **Durabilidad** | Persistente |
| **Prefetch Count** | 10 mensajes por worker |
| **Workers** | 2-5 (escalable) |

---

### Flujo de Mensaje Optimizado

![Diagrama de Secuencia - CU04: Registrar Idea](./diagrama/mensaje_optimizado.png)

---

### M√©tricas de Rendimiento Esperadas

| M√©trica | Sin Optimizaci√≥n | Con Optimizaci√≥n | Mejora |
|---|---|---|---|
| **Latencia P95 (1 sala, 100 usuarios)** | ~500ms | ~150ms | 70% ‚Üì |
| **Throughput (mensajes/seg)** | ~200 msg/s | ~1000 msg/s | 5x ‚Üë |
| **Conexiones Concurrentes** | ~500 | ~5000 | 10x ‚Üë |
| **Latencia de Lectura (mensajes recientes)** | ~20ms (SQL) | ~1ms (Redis) | 95% ‚Üì |

---

### Conclusi√≥n

Se han instanciado **5 elementos de infraestructura** para optimizar el rendimiento:
1. Redis Pub/Sub Adapter
2. Redis Cache
3. Load Balancer NGINX
4. M√∫ltiples Instancias (2-10 pods)
5. RabbitMQ Queue para persistencia as√≠ncrona

Estos elementos permiten cumplir con los escenarios ESC-01 y ESC-08.

---

[üè† Home](../../../README.md) | [Siguiente ‚û°Ô∏è](../9.4.5/9.4.5.md)
