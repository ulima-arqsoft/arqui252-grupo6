> [0. Acerca del Grupo](../../0.md) ‚Ä∫ [0.7. Trabajo Individual (Patrones Cloud)](../0.7.md) ‚Ä∫ [0.7.2. Integrante 2](0.7.2.md)

# 0.7.2. Integrante 2
# GATEWAY OFFLOADING DEMO

> **ARQUITECTURA DE SOFTWARE ‚Äî Universidad de Lima (2025)**

---

## Prop√≥sito del Proyecto

Demostrar el funcionamiento del patr√≥n **Gateway Offloading**, donde el Gateway (NGINX) asume la responsabilidad de autenticaci√≥n y control de tr√°fico, descargando estas tareas de los microservicios internos.

Este repositorio contiene una demo funcional de Gateway Offloading usando NGINX como gateway y dos microservicios simulados en Node.js (`svc-users` y `svc-collab`). El gateway centraliza la autenticaci√≥n (a trav√©s de `auth_request`), aplica rate limiting y enruta las peticiones a los servicios internos.

### Archivos clave

| Archivo | Descripci√≥n |
|---|---|
| `gateway/nginx.conf` | Configuraci√≥n de NGINX (auth_request, `limit_req_zone`, `proxy_pass`) |
| `svc-users/app.js` | Servicio que valida tokens (demo: compara con `validtoken`) |
| `svc-users/package.json` | Define `type: "module"` para ESM |
| `svc-collab/app.js` | Servicio que responde a `/api/chat/ping` |
| `svc-collab/package.json` | Define `type: "module"` |
| `docker-compose.yml` | Orquesta los contenedores (gateway + svc-users + svc-collab) |

---

## üõ†Ô∏è C√≥mo ejecutar la demo (PowerShell)

1. Levantar los contenedores en segundo plano:

```powershell
docker-compose up -d
```

2. Verificar que los contenedores est√©n corriendo:

```powershell
docker ps
```

3. Ver logs si necesitas diagnosticar:

```powershell
docker-compose logs -f
```

> Nota PowerShell: en PowerShell `curl` es un alias de `Invoke-WebRequest`. Usa `curl.exe` para el cliente curl real incluido en Windows, o la sintaxis de `Invoke-WebRequest` para enviar headers.

Ejemplo con `curl.exe` (recomendado en PowerShell):

```powershell
curl.exe -H "Authorization: Bearer validtoken" http://localhost:8080/api/chat/ping
```

Ejemplo equivalente con `Invoke-WebRequest`:

```powershell
Invoke-WebRequest -Uri "http://localhost:8080/api/chat/ping" -Headers @{ Authorization = "Bearer validtoken" }
```

---

## Qu√© probamos y resultados observados

| Escenario | Comando | Resultado esperado | Resultado obtenido |
|---:|---|---:|---|
| Petici√≥n autorizada | `curl.exe -H "Authorization: Bearer validtoken" http://localhost:8080/api/chat/ping` | 200 OK | `{"message":"pong from svc-collab!"}` |
| Petici√≥n sin token | `curl.exe http://localhost:8080/api/chat/ping` | 401 Unauthorized | 401 Unauthorized |
| Rate limiting (5 peticiones r√°pidas) | `for ($i = 1; $i -le 5; $i++) { curl.exe -H "Authorization: Bearer validtoken" http://localhost:8080/api/chat/ping }` | 429 / 503 | 4 respuestas `pong` y 1 respuesta `503 Service Temporarily Unavailable` |

La aparici√≥n de 503 confirma que el rate limiter de NGINX est√° activo y bloquea peticiones cuando se excede la configuraci√≥n (`limit_req zone=api_limit burst=3 nodelay`).

---

## Troubleshooting r√°pido

| S√≠ntoma | Causa | Soluci√≥n |
|---|---|---|
| "Cannot use import statement outside a module" | Node ejecuta ESM sin `type: "module"` | A√±adir `package.json` con `"type": "module"` en `svc-users` y `svc-collab` |
| `curl -H` falla en PowerShell | PowerShell mapea `curl` a `Invoke-WebRequest` | Usar `curl.exe` o `Invoke-WebRequest -Headers @{ Authorization = "Bearer ..." }` |
| `503 Service Temporarily Unavailable` | Rate limiting activo en NGINX | Comportamiento esperado; ajustar `limit_req` si es necesario |
| `500` / `502` en NGINX | `auth_request` falla (svc-users no accesible / upstream mal configurado) | Verificar `docker ps` y `docker-compose logs` y nombres de upstream en `nginx.conf` |

---

## Limitaciones y recomendaciones para producci√≥n

- Validaci√≥n de JWT: actualmente se usa una comprobaci√≥n simulada (`validtoken`). En producci√≥n valida firmas, expiraci√≥n y claims con bibliotecas (por ejemplo `jsonwebtoken`) y JWKS si corresponde.
- Seguridad de transporte: habilita TLS en el gateway y eval√∫a mTLS entre servicios internos.
- Observabilidad: centraliza logs, m√©tricas y tracing (Prometheus / Grafana / Jaeger / OpenTelemetry).
- Resiliencia: a√±ade timeouts, retries y circuit breakers para evitar fallos en cascada.

---

## ¬øCumple esto con Gateway Offloading?

S√≠. Basado en la configuraci√≥n actual y en las pruebas realizadas, la demo cumple con los aspectos centrales del patr√≥n Gateway Offloading:

- El Gateway (NGINX) es el √∫nico punto de entrada.
- El Gateway centraliza la validaci√≥n de tokens mediante `auth_request` a `svc-users`.
- El Gateway aplica control de tr√°fico (`limit_req`) antes de alcanzar los microservicios.
- Los microservicios (`svc-collab`) no gestionan autenticaci√≥n ni rate-limiting: esa responsabilidad est√° offloadeada al gateway.

> Observaci√≥n: es una demo did√°ctica. Para producci√≥n endurecer la verificaci√≥n JWT, cifrar el transporte y a√±adir observabilidad.

---

## Comandos √∫tiles

```powershell
# Levantar en segundo plano
docker-compose up -d

# Ver containers
docker ps

# Seguir logs
docker-compose logs -f

# Probar endpoint (curl.exe)
curl.exe -H "Authorization: Bearer validtoken" http://localhost:8080/api/chat/ping

# Probar endpoint (PowerShell native)
Invoke-WebRequest -Uri "http://localhost:8080/api/chat/ping" -Headers @{ Authorization = "Bearer validtoken" }
```

---

## Autor

**Imanol Castro Guti√©rrez**  
Universidad de Lima ‚Äî Arquitectura de Software (2025)

---



[‚¨ÖÔ∏è Anterior](../0.7.1/0.7.1.md) | [üè† Home](../../../README.md) | [Siguiente ‚û°Ô∏è](../0.7.3/0.7.3.md)