> [0. Acerca del Grupo](../../0.md) ‚Ä∫ [0.8. Temas Individuales (Parte 2)](../0.8.md) ‚Ä∫ [0.8.4. Integrante 4](0.8.4.md)

# 0.8.4. Integrante 4

# Gesti√≥n de Migraciones en BD relacionales

# Link VIDEO [PRESIONAR AQUI](https://drive.google.com/file/d/14cV584C9N7rf0Rbcv2d0u6yje22vrOod/view?usp=drive_link)

### 1. ¬øQu√© es la Gesti√≥n de Migraciones?

La gesti√≥n de migraciones es la pr√°ctica de administrar, versionar y controlar los cambios en el esquema de una base de datos relacional (tablas, columnas, √≠ndices, vistas, etc.) de manera sistem√°tica. Se puede pensar en ello como **"Git para tu base de datos"**. En lugar de ejecutar scripts SQL manualmente o modificar la estructura "al vuelo", los cambios se escriben en archivos (migraciones) que describen la evoluci√≥n de la base de datos desde un estado inicial hasta el estado actual.

### 2. ¬øPara qu√© sirve?

Su prop√≥sito principal es eliminar la inconsistencia y el error humano al desplegar cambios en la base de datos. Sirve para:

* **Estandarizar:** Asegurar que la estructura de la base de datos sea id√©ntica en todos los entornos (Local, Desarrollo, QA, Producci√≥n).
* **Automatizar:** Permitir que los cambios de base de datos se ejecuten autom√°ticamente dentro de pipelines de CI/CD (Integraci√≥n y Despliegue Continuo).
* **Auditar:** Saber exactamente cu√°ndo se hizo un cambio, qui√©n lo hizo y qu√© script se ejecut√≥.
* **Revertir (Rollback):** Proveer mecanismos para deshacer cambios si una actualizaci√≥n causa errores.

### 3. ¬øEn qu√© casos se usa?

* **Equipos de Desarrollo:** Cuando varios programadores trabajan en la misma aplicaci√≥n y necesitan compartir cambios de esquema sin "romper" la base de datos del compa√±ero.
* **Arquitectura de Microservicios:** Donde cada servicio tiene su propia base de datos y ciclo de vida; gestionarlas manualmente es imposible.
* **Entornos CI/CD:** Para que, al hacer un *deploy* de la aplicaci√≥n, la base de datos se actualice autom√°ticamente antes de que arranque el nuevo c√≥digo.
---

### 4. Ventajas y Desventajas

| Ventajas | Desventajas |
| :--- | :--- |
| **Reproducibilidad:** Puedes levantar una base de datos desde cero en segundos ejecutando todas las migraciones en orden. | **Curva de Aprendizaje:** Requiere que el equipo aprenda a no tocar la BD manualmente y usar la herramienta elegida. |
| **Seguridad:** Reduce dr√°sticamente el riesgo de borrar datos o romper tablas en producci√≥n por errores manuales. | **Rigidez:** Hacer cambios r√°pidos requiere crear un archivo de migraci√≥n, lo cual puede parecer lento al inicio. |
| **Trabajo en Equipo:** Resuelve conflictos de c√≥digo SQL entre desarrolladores (similar a un *merge conflict*). | **Manejo de Datos Masivos:** Migrar tablas con millones de registros puede bloquear la base de datos si la herramienta no se configura bien|
| **Independencia del c√≥digo:** Separa los cambios de estructura del c√≥digo de la aplicaci√≥n. | **Conflictos de Estado:** A veces la herramienta cree que la BD est√° en una versi√≥n, pero la realidad es otra (checksum errors), requiriendo intervenci√≥n manual. |

---

### 5. Tecnolog√≠as y Herramientas Destacadas

Aqu√≠ comparamos las tres herramientas que mencionaste, ya que representan enfoques distintos:

#### A. Flyway 
Es la opci√≥n m√°s popular para quienes prefieren la simplicidad y el control total del SQL.

#### B. Liquibase 
Es m√°s robusto y permite definir cambios en formatos agn√≥sticos a la base de datos (XML, YAML, JSON) o SQL.

#### C. Atlas (Ariga)
Es una herramienta moderna (escrita en Go) que introduce el concepto de "Schema-as-Code".

# DEMO


El objetivo de esta demostraci√≥n es ilustrar c√≥mo gestionar el ciclo de vida de una base de datos relacional utilizando **Flyway**. Se simular√° un entorno de producci√≥n donde es necesario realizar cambios estructurales complejos (refactorizaci√≥n) sin p√©rdida de datos y de manera automatizada.

**Tecnolog√≠as:** Docker, PostgreSQL 15, Flyway.

## 2\. El Escenario de Negocio (El Problema)

Tenemos una aplicaci√≥n heredada (Legacy) con una tabla de `usuarios`.

  * **Estado Actual:** El nombre y el apellido est√°n almacenados en una sola columna (`nombre_completo`).
  * **Nuevo Requisito:** Marketing necesita segmentar a los usuarios por nombre para campa√±as personalizadas.
  * **El Reto:** Debemos separar la columna en `nombre` y `apellido` **sin perder los datos existentes** de los clientes y sin realizar intervenciones manuales propensas a error.

## 3\. Estructura del Proyecto

El proyecto utiliza **Docker Compose** para orquestar la base de datos y el migrador.

```text
/demo-flyway
‚îú‚îÄ‚îÄ docker-compose.yml       # Orquestador de servicios
‚îî‚îÄ‚îÄ sql/                     # Carpeta de migraciones
    ‚îú‚îÄ‚îÄ V1__creartabla.sql   # Estado inicial (Versi√≥n 1)
    ‚îî‚îÄ‚îÄ V2__separar.sql      # Refactorizaci√≥n (Versi√≥n 2)
```
-----

## 4\. Ejecuci√≥n de la Demo

### Fase 1: Despliegue del Estado Inicial (V1)

En esta fase simulamos el estado actual de producci√≥n. Solo el archivo `V1` es visible para Flyway.

**Archivo:** `sql/V1__creartabla.sql`

```sql
CREATE TABLE usuarios (
    id SERIAL PRIMARY KEY,
    nombre_completo VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL
);

-- Datos semilla (Simulando producci√≥n)
INSERT INTO usuarios (nombre_completo, email) VALUES ('Juan Perez', 'juan@test.com');
INSERT INTO usuarios (nombre_completo, email) VALUES ('Maria Gomez', 'maria@test.com');
```

**Pasos:**

1.  Asegurar que en la carpeta `sql/` solo exista el archivo `.sql` de la V1. (El de la V2 debe estar renombrado como `separar` o `separar.txt`).
2.  Ejecutar en terminal:
    ```bash
    docker-compose up
    ```
3.  **Resultado:** Se crea la base de datos y la tabla con datos "sucios" (mezclados).

### Fase 2: Aplicaci√≥n de la Migraci√≥n (V2)

Simulamos el despliegue de una nueva funcionalidad. Activamos el segundo script.

**Archivo:** `sql/V2__separar.sql`
Este script es h√≠brido: altera la estructura (DDL) y transforma los datos (DML).

```sql
-- 1. Crear columnas destino
ALTER TABLE usuarios ADD COLUMN nombre VARCHAR(50);
ALTER TABLE usuarios ADD COLUMN apellido VARCHAR(50);

-- 2. MIGRACI√ìN DE DATOS (L√≥gica de negocio)
UPDATE usuarios 
SET 
    nombre = SPLIT_PART(nombre_completo, ' ', 1),
    apellido = SPLIT_PART(nombre_completo, ' ', 2);

-- 3. Limpieza (Eliminar columna obsoleta)
ALTER TABLE usuarios DROP COLUMN nombre_completo;
```

**Pasos:**

1.  Renombrar el archivo `separar` a `V2__separar.sql`.
2.  Ejecutar nuevamente:
    ```bash
    docker-compose up
    ```
3.  **Resultado:** Flyway detecta el nuevo archivo, valida que la V1 no haya cambiado (checksum) y aplica √∫nicamente la V2.

-----

## 5\. Validaci√≥n y Auditor√≠a

Para verificar el √©xito de la operaci√≥n, consultamos la base de datos (v√≠a pgAdmin o terminal):

### A. Verificaci√≥n de Datos

```sql
SELECT * FROM usuarios;
```

*Resultado:* Los usuarios "Juan" y "Perez" ahora est√°n en columnas separadas. La columna `nombre_completo` ha desaparecido.

### B. Tabla de Auditor√≠a (Flyway Schema History)

Flyway crea autom√°ticamente una tabla oculta para llevar el control.

```sql
SELECT * FROM flyway_schema_history;
```

| version | description | type | script | checksum | installed\_on |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 1 | creartabla | SQL | V1\_\_creartabla.sql | 123456... | 2023-10-27... |
| 2 | separar | SQL | V2\_\_separar.sql | 987654... | 2023-10-27... |

**Importancia:** Esta tabla garantiza que todos los entornos (Dev, QA, Prod) est√©n sincronizados. Si alguien intenta alterar un script ya ejecutado, Flyway bloquear√° el despliegue por seguridad.


---

[‚¨ÖÔ∏è Anterior](../0.8.3/0.8.3.md) | [üè† Home](../../../README.md) | [Siguiente ‚û°Ô∏è](../0.8.5/0.8.5.md)